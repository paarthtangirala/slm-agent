<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 SLM Personal Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #495057;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .logo p {
            color: #6c757d;
            font-size: 14px;
        }

        .mode-selector {
            margin-bottom: 20px;
        }

        .mode-btn {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .mode-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .mode-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .mode-btn .icon {
            margin-right: 10px;
            font-size: 16px;
        }

        .conversations {
            flex: 1;
            margin: 20px 0;
        }

        .conversations h3 {
            color: #495057;
            font-size: 14px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .new-chat-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .new-chat-btn:hover {
            background: #5a6fd8;
        }

        .conversation-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .conversation-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .conversation-item.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .conversation-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .conversation-date {
            font-size: 11px;
            opacity: 0.7;
        }

        .upload-section {
            margin: 20px 0;
        }

        .upload-section h3 {
            color: #495057;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e7f3ff;
            transform: scale(1.02);
        }

        .upload-area input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: #6c757d;
        }

        .upload-text {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 10px;
            color: #adb5bd;
        }

        .file-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 3px 0;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            font-size: 11px;
        }

        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-type {
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            margin-left: 5px;
        }

        .delete-file {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 9px;
            cursor: pointer;
            margin-left: 5px;
        }

        .delete-file:hover {
            background: #c82333;
        }

        .upload-progress {
            display: none;
            margin-top: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s;
        }

        .status {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 8px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: white;
        }

        .chat-header h2 {
            color: #495057;
            margin-bottom: 5px;
        }

        .chat-header p {
            color: #6c757d;
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: white;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .message.user .message-avatar {
            background: #6c757d;
            color: white;
        }

        .message.assistant .message-avatar {
            background: #667eea;
            color: white;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: white;
        }

        .input-form {
            display: flex;
            gap: 10px;
        }

        .input-group {
            flex: 1;
            position: relative;
        }

        .input-field {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            border-color: #667eea;
        }

        .send-btn {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .send-btn:hover {
            background: #5a6fd8;
        }

        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .mic-btn {
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .mic-btn:hover {
            background: #218838;
            transform: translateY(-50%) scale(1.1);
        }

        .mic-btn.recording {
            background: #dc3545;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.1); }
            100% { transform: translateY(-50%) scale(1); }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .loading.show {
            display: block;
        }

        .result-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .result-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
        }

        .search-results {
            margin-top: 10px;
        }

        .search-result {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .search-result-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .search-result-url {
            font-size: 12px;
            color: #28a745;
            margin-bottom: 5px;
        }

        .search-result-snippet {
            font-size: 13px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            
            .sidebar {
                width: 250px;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h1>🤖 SLM Agent</h1>
                <p>Local AI Assistant</p>
            </div>
            
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="chat">
                    <span class="icon">💬</span>
                    Chat & Summarize
                </button>
                <button class="mode-btn" data-mode="email">
                    <span class="icon">📧</span>
                    Draft Email
                </button>
                <button class="mode-btn" data-mode="search">
                    <span class="icon">🔍</span>
                    Web Search
                </button>
                <button class="mode-btn" data-mode="docs">
                    <span class="icon">📚</span>
                    Query Documents
                </button>
                <button class="mode-btn" data-mode="code">
                    <span class="icon">👨‍💻</span>
                    Code Analysis
                </button>
                <button class="mode-btn" data-mode="data">
                    <span class="icon">📊</span>
                    Data Insights
                </button>
                <button class="mode-btn" data-mode="meeting">
                    <span class="icon">📋</span>
                    Meeting Notes
                </button>
                <button class="mode-btn" data-mode="research">
                    <span class="icon">📄</span>
                    Research Papers
                </button>
                <button class="mode-btn" data-mode="voice">
                    <span class="icon">🎤</span>
                    Voice Chat
                </button>
                <button class="mode-btn" data-mode="integrations">
                    <span class="icon">🔗</span>
                    Integrations
                </button>
                <button class="mode-btn" data-mode="security">
                    <span class="icon">🔒</span>
                    Security & Privacy
                </button>
                <button class="mode-btn" data-mode="data-viz">
                    <span class="icon">📊</span>
                    Data Visualization
                </button>
            </div>
            
            <div class="conversations">
                <h3>
                    Conversations
                    <button class="new-chat-btn" id="new-chat-btn">+ New</button>
                </h3>
                <div class="conversation-list" id="conversation-list">
                    <!-- Conversations will be loaded here -->
                </div>
            </div>
            
            <div class="upload-section">
                <h3>📁 Upload Documents</h3>
                <div class="upload-area" id="upload-area">
                    <input type="file" id="file-input" multiple accept=".pdf,.docx,.xlsx,.txt,.md,.py,.js,.png,.jpg,.jpeg">
                    <div class="upload-icon">📄</div>
                    <div class="upload-text">Drop files here or click to browse</div>
                    <div class="upload-hint">PDF, Word, Excel, images, code files</div>
                </div>
                <div class="upload-progress" id="upload-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div style="font-size: 10px; text-align: center; margin-top: 5px;" id="upload-status">Uploading...</div>
                </div>
                <div class="file-list" id="file-list">
                    <!-- Uploaded files will appear here -->
                </div>
            </div>
            
            <div class="status">
                <div>
                    <span class="status-dot"></span>
                    <strong>Status: Online</strong>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #495057;">
                    Model: phi3:mini<br>
                    Search: SerpAPI (Google)
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="chat-header">
                <h2 id="mode-title">Chat & Summarize</h2>
                <p id="mode-description">Ask questions, summarize text, or have a conversation</p>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <div class="message assistant">
                    <div class="message-avatar">🤖</div>
                    <div class="message-content">
                        Welcome to your personal SLM Agent! I'm running locally on your machine with phi3:mini. I can help you with:
                        <br><br>
                        • <strong>Summarizing</strong> long texts and conversations<br>
                        • <strong>Drafting</strong> professional emails<br>
                        • <strong>Searching</strong> the web with AI analysis<br>
                        • <strong>Querying</strong> your local documents<br>
                        • <strong>Analyzing</strong> code for quality and best practices<br>
                        • <strong>Extracting insights</strong> from data and charts<br>
                        • <strong>Processing</strong> meeting notes for action items<br>
                        • <strong>Summarizing</strong> research papers and findings<br>
                        <br>
                        What would you like to do today?
                    </div>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div>🤖 Thinking...</div>
            </div>
            
            <div class="chat-input">
                <form class="input-form" id="input-form">
                    <div class="input-group">
                        <input type="text" class="input-field" id="user-input" 
                               placeholder="Type your message here..." autocomplete="off">
                        <button type="button" class="mic-btn" id="mic-btn" title="Voice Input">
                            🎤
                        </button>
                    </div>
                    <button type="submit" class="send-btn" id="send-btn">Send</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // App state
        let currentMode = 'chat';
        let currentConversationId = null;
        const baseURL = '';
        let conversations = [];
        
        // Mode configurations
        const modes = {
            chat: {
                title: 'Chat & Summarize',
                description: 'Ask questions, summarize text, or have a conversation',
                placeholder: 'Type your message or paste text to summarize...',
                endpoint: '/summarize'
            },
            email: {
                title: 'Draft Email',
                description: 'Generate professional emails with context',
                placeholder: 'Describe the email you want to draft...',
                endpoint: '/draft-email'
            },
            search: {
                title: 'Web Search',
                description: 'Search the web and get AI-powered summaries',
                placeholder: 'Search for anything...',
                endpoint: '/web-search'
            },
            docs: {
                title: 'Query Documents',
                description: 'Ask questions about your uploaded documents',
                placeholder: 'Ask about your documents...',
                endpoint: '/local-query'
            },
            code: {
                title: 'Code Analysis',
                description: 'Analyze code for quality, syntax, and best practices',
                placeholder: 'Paste your code here for analysis...',
                endpoint: '/analyze-code'
            },
            data: {
                title: 'Data Insights',
                description: 'Analyze data and generate visualization insights',
                placeholder: 'Enter data or filename to analyze...',
                endpoint: '/visualize-data'
            },
            meeting: {
                title: 'Meeting Notes',
                description: 'Extract action items and decisions from meeting notes',
                placeholder: 'Paste your meeting notes here...',
                endpoint: '/extract-meeting-notes'
            },
            research: {
                title: 'Research Papers',
                description: 'Analyze research papers and extract key findings',
                placeholder: 'Paste research paper content or abstract...',
                endpoint: '/analyze-research-paper'
            },
            voice: {
                title: 'Voice Chat',
                description: 'Voice-enabled AI interaction with speech synthesis',
                placeholder: 'Click the microphone to start voice chat or type to hear speech...',
                endpoint: '/voice/speak'
            },
            integrations: {
                title: 'Integration Hub',
                description: 'Connect and manage external services like GitHub, Slack, Google Drive',
                placeholder: 'Manage your integrations with external services...',
                endpoint: '/integrations/available'
            },
            security: {
                title: 'Security & Privacy',
                description: 'Data protection, encryption, audit logs, and privacy controls',
                placeholder: 'Manage your security and privacy settings...',
                endpoint: '/security/dashboard'
            },
            'data-viz': {
                title: 'Visual Data Explorer',
                description: 'Create interactive charts, graphs, and data visualizations',
                placeholder: 'Explore and visualize your data...',
                endpoint: '/data/visualizations'
            }
        };

        // DOM elements
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const inputForm = document.getElementById('input-form');
        const loading = document.getElementById('loading');
        const modeTitle = document.getElementById('mode-title');
        const modeDescription = document.getElementById('mode-description');
        const conversationList = document.getElementById('conversation-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const uploadProgress = document.getElementById('upload-progress');
        const progressFill = document.getElementById('progress-fill');
        const uploadStatus = document.getElementById('upload-status');
        const fileList = document.getElementById('file-list');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateModeUI();
            
            // Load conversations in background (non-blocking)
            setTimeout(() => {
                loadConversations();
                checkHealth();
            }, 100);
            
            // Mode switching
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.dataset.mode;
                    switchMode(mode);
                });
            });

            // Form submission
            inputForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleSubmit();
            });
            
            // New chat button
            newChatBtn.addEventListener('click', function() {
                startNewConversation();
            });
            
            // File upload functionality
            setupFileUpload();
            loadDocuments();
            
            // Initialize voice functionality
            initializeVoice();
        });

        function switchMode(mode) {
            currentMode = mode;
            
            // Update active button
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            updateModeUI();
        }

        function updateModeUI() {
            const config = modes[currentMode];
            modeTitle.textContent = config.title;
            modeDescription.textContent = config.description;
            userInput.placeholder = config.placeholder;
        }

        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                const statusEl = document.querySelector('.status');
                if (data.status === 'healthy' && data.ollama_connected) {
                    statusEl.innerHTML = `
                        <div>
                            <span class="status-dot"></span>
                            <strong>Status: Online</strong>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #495057;">
                            Model: phi3:mini<br>
                            Search: SerpAPI (Google)
                        </div>
                    `;
                } else {
                    statusEl.innerHTML = `
                        <div>
                            <span class="status-dot" style="background: #dc3545;"></span>
                            <strong>Status: Offline</strong>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #495057;">
                            Check server connection
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        function addMessage(content, isUser = false, isHTML = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? '👤' : '🤖';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isHTML) {
                contentDiv.innerHTML = content;
            } else {
                contentDiv.textContent = content;
            }
            
            if (isUser) {
                messageDiv.appendChild(contentDiv);
                messageDiv.appendChild(avatar);
            } else {
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function setLoading(show) {
            loading.classList.toggle('show', show);
            sendBtn.disabled = show;
            if (show) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        async function loadConversations() {
            try {
                // Show loading in conversation list
                conversationList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d; font-size: 12px;">Loading conversations...</div>';
                
                const response = await fetch('/conversations');
                const data = await response.json();
                conversations = data.conversations;
                renderConversations();
            } catch (error) {
                console.error('Failed to load conversations:', error);
                conversationList.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545; font-size: 12px;">Failed to load</div>';
            }
        }

        function renderConversations() {
            conversationList.innerHTML = '';
            
            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                if (conv.id === currentConversationId) {
                    item.classList.add('active');
                }
                
                const date = new Date(conv.updated_at).toLocaleDateString();
                item.innerHTML = `
                    <div class="conversation-title">${conv.title}</div>
                    <div class="conversation-date">${date}</div>
                `;
                
                item.addEventListener('click', () => {
                    selectConversation(conv.id);
                });
                
                conversationList.appendChild(item);
            });
        }

        async function selectConversation(conversationId) {
            currentConversationId = conversationId;
            renderConversations();
            
            // Load conversation messages
            try {
                const response = await fetch(`/conversations/${conversationId}/messages`);
                const data = await response.json();
                
                // Clear current messages
                chatMessages.innerHTML = '';
                
                // Add messages to chat
                data.messages.forEach(msg => {
                    addMessage(msg.content, msg.role === 'user', false);
                });
                
            } catch (error) {
                console.error('Failed to load conversation:', error);
                addMessage('❌ Failed to load conversation', false);
            }
        }

        function startNewConversation() {
            currentConversationId = null;
            
            // Clear chat messages
            chatMessages.innerHTML = '';
            
            // Add welcome message
            addMessage(`Welcome to your personal SLM Agent! I'm running locally on your machine with phi3:mini. I can help you with:
                <br><br>
                • <strong>Summarizing</strong> long texts and conversations<br>
                • <strong>Drafting</strong> professional emails<br>
                • <strong>Searching</strong> the web with AI analysis<br>
                • <strong>Querying</strong> your local documents<br>
                • <strong>Analyzing</strong> code for quality and best practices<br>
                • <strong>Extracting insights</strong> from data and charts<br>
                • <strong>Processing</strong> meeting notes for action items<br>
                • <strong>Summarizing</strong> research papers and findings<br>
                <br>
                What would you like to do today?`, false, true);
            
            // Update conversation list
            renderConversations();
        }

        async function handleSubmit() {
            const message = userInput.value.trim();
            if (!message) return;

            // Add user message to UI
            addMessage(message, true);
            userInput.value = '';
            setLoading(true);

            try {
                let response;
                
                if (currentMode === 'chat') {
                    // Use the new chat endpoint with memory
                    response = await fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message,
                            conversation_id: currentConversationId,
                            mode: currentMode
                        })
                    });
                } else {
                    // Use original endpoints for other modes
                    switch (currentMode) {
                        case 'email':
                            response = await fetch('/draft-email', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    recipient: 'recipient@example.com',
                                    subject: 'Email Request',
                                    context: message,
                                    tone: 'professional'
                                })
                            });
                            break;
                            
                        case 'search':
                            response = await fetch('/web-search', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    query: message,
                                    max_results: 3
                                })
                            });
                            break;
                            
                        case 'docs':
                            response = await fetch('/local-query', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    query: message,
                                    max_results: 3
                                })
                            });
                            break;
                            
                        case 'code':
                            response = await fetch('/analyze-code', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    code: message,
                                    language: 'auto',
                                    analysis_type: 'comprehensive'
                                })
                            });
                            break;
                            
                        case 'data':
                            response = await fetch('/visualize-data', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    data_source: message,
                                    chart_type: 'auto',
                                    analysis_focus: 'trends'
                                })
                            });
                            break;
                            
                        case 'meeting':
                            response = await fetch('/extract-meeting-notes', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    notes: message,
                                    extract_actions: true,
                                    extract_decisions: true
                                })
                            });
                            break;
                            
                        case 'research':
                            response = await fetch('/analyze-research-paper', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    content: message,
                                    focus_areas: ['methodology', 'findings', 'conclusions']
                                })
                            });
                            break;
                            
                        case 'voice':
                            // Handle text-to-speech
                            response = await fetch('/voice/speak', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    text: message,
                                    voice: 'default',
                                    speed: 1.0
                                })
                            });
                            
                            if (response.ok) {
                                // Create audio player for the response
                                const audioBlob = await response.blob();
                                const audioUrl = URL.createObjectURL(audioBlob);
                                const audioPlayer = document.createElement('audio');
                                audioPlayer.controls = true;
                                audioPlayer.src = audioUrl;
                                audioPlayer.autoplay = true;
                                
                                // Add response message with audio player
                                const responseDiv = document.createElement('div');
                                responseDiv.innerHTML = `
                                    <div style="margin: 10px 0;">
                                        <p><strong>🔊 AI Voice Response:</strong></p>
                                        <p>"${message}"</p>
                                        ${audioPlayer.outerHTML}
                                    </div>
                                `;
                                addMessage(responseDiv.innerHTML, false);
                                return; // Skip normal response handling
                            }
                            break;
                            
                        case 'integrations':
                            // Load and display integrations interface
                            await loadIntegrationsInterface();
                            return; // Skip normal response handling
                            break;
                            
                        case 'security':
                            // Load and display security dashboard
                            await loadSecurityDashboard();
                            return; // Skip normal response handling
                            break;
                            
                        case 'data-viz':
                            // Load and display data visualization interface
                            await loadDataVisualizationInterface();
                            return; // Skip normal response handling
                            break;
                    }
                }

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Request failed');
                }

                // Handle response
                if (currentMode === 'chat' && data.conversation_id) {
                    // Update current conversation ID
                    currentConversationId = data.conversation_id;
                    addMessage(data.response, false);
                    
                    // Refresh conversation list
                    await loadConversations();
                } else {
                    // Format response for other modes
                    formatResponse(data, currentMode);
                }
                
            } catch (error) {
                addMessage(`❌ Error: ${error.message}`, false);
            } finally {
                setLoading(false);
            }
        }

        function formatResponse(data, mode) {
            let content = '';
            
            switch (mode) {
                case 'chat':
                    content = data.summary || data.response || 'No response received';
                    break;
                    
                case 'email':
                    content = `<div class="result-section">
                        <div class="result-title">📧 Email Draft</div>
                        <div style="white-space: pre-wrap; font-family: monospace; background: white; padding: 15px; border-radius: 8px; margin-top: 10px;">${data.draft}</div>
                    </div>`;
                    break;
                    
                case 'search':
                    content = `<div class="result-section">
                        <div class="result-title">🔍 Search Results & Summary</div>
                        <div style="margin-bottom: 15px;"><strong>AI Summary:</strong><br>${data.summary}</div>
                        <div class="search-results">`;
                    
                    data.results.forEach(result => {
                        content += `<div class="search-result">
                            <div class="search-result-title">${result.title}</div>
                            <div class="search-result-url">${result.url}</div>
                            <div class="search-result-snippet">${result.snippet || 'No description available'}</div>
                        </div>`;
                    });
                    
                    content += `</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                            Provider: ${data.provider} | Results: ${data.results.length}
                        </div>
                    </div>`;
                    break;
                    
                case 'docs':
                    content = `<div class="result-section">
                        <div class="result-title">📚 Document Query Result</div>
                        <div style="margin-bottom: 15px;"><strong>Answer:</strong><br>${data.answer}</div>
                        <div style="font-size: 12px; color: #6c757d;">
                            Sources: ${data.sources.join(', ')} | Documents used: ${data.num_documents_used}
                        </div>
                    </div>`;
                    break;
                    
                case 'code':
                    content = `<div class="result-section">
                        <div class="result-title">👨‍💻 Code Analysis Result</div>
                        <div style="margin-bottom: 15px;"><strong>Language:</strong> ${data.language} | <strong>Analysis Type:</strong> ${data.analysis_type}</div>
                        <div style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">${data.analysis}</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                            Code length: ${data.code_length} characters
                        </div>
                    </div>`;
                    break;
                    
                case 'data':
                    content = `<div class="result-section">
                        <div class="result-title">📊 Data Insights</div>
                        <div style="margin-bottom: 15px;"><strong>Source:</strong> ${data.data_source} | <strong>Focus:</strong> ${data.analysis_focus}</div>
                        <div style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">${data.analysis}</div>
                        <div style="margin-top: 10px; font-size: 11px; color: #6c757d; background: white; padding: 8px; border-radius: 4px;">
                            <strong>Data Preview:</strong><br>${data.data_preview}
                        </div>
                    </div>`;
                    break;
                    
                case 'meeting':
                    content = `<div class="result-section">
                        <div class="result-title">📋 Meeting Analysis</div>
                        <div style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">${data.analysis}</div>
                        <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                            Original length: ${data.original_length} characters | Actions: ${data.extracted_actions ? 'Yes' : 'No'} | Decisions: ${data.extracted_decisions ? 'Yes' : 'No'}
                        </div>
                    </div>`;
                    break;
                    
                case 'research':
                    content = `<div class="result-section">
                        <div class="result-title">📄 Research Paper Analysis</div>
                        <div style="margin-bottom: 15px;"><strong>Focus Areas:</strong> ${data.focus_areas.join(', ')}</div>
                        <div style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #6f42c1;">${data.analysis}</div>
                        <div style="margin-top: 10px; font-size: 11px; color: #6c757d; background: white; padding: 8px; border-radius: 4px;">
                            <strong>Content Preview:</strong><br>${data.content_preview}
                        </div>
                    </div>`;
                    break;
            }
            
            addMessage(content, false, true);
        }

        // File upload functionality
        function setupFileUpload() {
            // Click to upload
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // File selection
            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                uploadFiles(files);
            });
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            uploadFiles(files);
            fileInput.value = ''; // Reset input
        }

        async function uploadFiles(files) {
            if (files.length === 0) return;

            const totalFiles = files.length;
            let completed = 0;

            uploadProgress.style.display = 'block';
            uploadStatus.textContent = `Uploading ${totalFiles} file(s)...`;

            for (const file of files) {
                try {
                    await uploadSingleFile(file);
                    completed++;
                    const percent = (completed / totalFiles) * 100;
                    progressFill.style.width = percent + '%';
                    uploadStatus.textContent = `Uploaded ${completed}/${totalFiles} files`;
                } catch (error) {
                    console.error('Upload failed:', error);
                    addMessage(`❌ Failed to upload ${file.name}: ${error.message}`, false);
                }
            }

            // Hide progress after completion
            setTimeout(() => {
                uploadProgress.style.display = 'none';
                progressFill.style.width = '0%';
            }, 2000);

            // Refresh file list
            await loadDocuments();
        }

        async function uploadSingleFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detail || 'Upload failed');
            }

            // Show success message
            addMessage(`📄 Successfully uploaded ${file.name} (${result.chunks_created} chunks created)`, false);

            return result;
        }

        async function loadDocuments() {
            try {
                const response = await fetch('/documents');
                const data = await response.json();
                renderFileList(data.files);
            } catch (error) {
                console.error('Failed to load documents:', error);
            }
        }

        function renderFileList(files) {
            fileList.innerHTML = '';

            if (files.length === 0) {
                fileList.innerHTML = '<div style="text-align: center; padding: 10px; color: #6c757d; font-size: 11px;">No documents uploaded</div>';
                return;
            }

            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-name';
                fileName.textContent = file.name;
                fileName.title = file.name;

                const fileType = document.createElement('span');
                fileType.className = 'file-type';
                fileType.textContent = file.type;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-file';
                deleteBtn.textContent = '×';
                deleteBtn.onclick = () => deleteDocument(file.name);

                item.appendChild(fileName);
                item.appendChild(fileType);
                item.appendChild(deleteBtn);
                fileList.appendChild(item);
            });
        }

        async function deleteDocument(filename) {
            if (!confirm(`Delete ${filename}?`)) return;

            try {
                const response = await fetch(`/documents/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    addMessage(`🗑️ Deleted ${filename}`, false);
                    await loadDocuments();
                } else {
                    throw new Error(result.detail || 'Delete failed');
                }
            } catch (error) {
                addMessage(`❌ Failed to delete ${filename}: ${error.message}`, false);
            }
        }

        // Voice functionality
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // Initialize voice functionality
        async function initializeVoice() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Voice recording not supported in this browser');
                }

                // Check microphone permission
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop()); // Stop the test stream
                
                // Set up microphone button click handler
                micBtn.addEventListener('click', toggleRecording);
                
                console.log('Voice functionality initialized');
            } catch (error) {
                console.warn('Voice functionality disabled:', error.message);
                micBtn.style.display = 'none'; // Hide mic button if not available
            }
        }

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    }
                });

                // Try to use WAV format if supported, fallback to WebM
                let options = {};
                if (MediaRecorder.isTypeSupported('audio/wav')) {
                    options.mimeType = 'audio/wav';
                } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                    options.mimeType = 'audio/webm';
                } else {
                    // Use default
                }
                
                mediaRecorder = new MediaRecorder(stream, options);

                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const mimeType = options.mimeType || 'audio/webm';
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    await sendVoiceMessage(audioBlob);
                    
                    // Stop all tracks to release microphone
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start(100); // Collect data every 100ms
                isRecording = true;

                // Update UI
                micBtn.classList.add('recording');
                micBtn.title = 'Stop Recording';
                userInput.placeholder = '🎤 Recording... Click microphone to stop';

                addMessage('🎤 Recording started... Click microphone again to stop', false);

            } catch (error) {
                console.error('Recording failed:', error);
                addMessage(`❌ Recording failed: ${error.message}`, false);
                isRecording = false;
                micBtn.classList.remove('recording');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                // Update UI
                micBtn.classList.remove('recording');
                micBtn.title = 'Voice Input';
                userInput.placeholder = modes[currentMode].placeholder;

                addMessage('🎤 Recording stopped, processing...', false);
            }
        }

        async function sendVoiceMessage(audioBlob) {
            try {
                setLoading(true);

                // Prepare form data with correct filename
                const formData = new FormData();
                const fileExtension = audioBlob.type.includes('wav') ? '.wav' : '.webm';
                formData.append('audio', audioBlob, `recording${fileExtension}`);

                const transcribeResponse = await fetch('/voice/transcribe', {
                    method: 'POST',
                    body: formData
                });

                if (!transcribeResponse.ok) {
                    let errorMessage = 'Transcription failed';
                    try {
                        const error = await transcribeResponse.json();
                        errorMessage = error.detail || errorMessage;
                    } catch (parseError) {
                        errorMessage = `HTTP ${transcribeResponse.status}: ${transcribeResponse.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const transcribeData = await transcribeResponse.json();
                const transcribedText = transcribeData.text;

                if (!transcribedText || transcribedText.trim() === '') {
                    throw new Error('No speech detected or transcription was empty');
                }

                // Add transcribed text as user message
                addMessage(`🎤 "${transcribedText}"`, true);

                // Send transcribed text for AI response
                if (currentMode === 'voice') {
                    // In voice mode, get both text and audio response
                    const chatResponse = await fetch('/voice/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: transcribedText,
                            conversation_id: currentConversationId,
                            voice: 'default',
                            speed: 1.0
                        })
                    });

                    if (chatResponse.ok) {
                        const chatData = await chatResponse.json();
                        
                        // Add text response
                        addMessage(chatData.response, false);
                        
                        // Update conversation ID
                        if (chatData.conversation_id) {
                            currentConversationId = chatData.conversation_id;
                            await loadConversations();
                        }

                        // Play audio response if available
                        if (chatData.audio_url) {
                            const audio = new Audio(chatData.audio_url);
                            audio.play().catch(e => console.warn('Audio playback failed:', e));
                            
                            // Add audio player to the message
                            const lastMessage = chatMessages.lastElementChild;
                            if (lastMessage) {
                                const audioPlayer = document.createElement('audio');
                                audioPlayer.controls = true;
                                audioPlayer.src = chatData.audio_url;
                                audioPlayer.style.marginTop = '10px';
                                audioPlayer.style.width = '100%';
                                lastMessage.querySelector('.message-content').appendChild(audioPlayer);
                            }
                        }
                    } else {
                        throw new Error('Failed to get AI response');
                    }
                } else {
                    // For other modes, use normal text processing
                    userInput.value = transcribedText;
                    await handleSubmit();
                }

            } catch (error) {
                console.error('Voice message failed:', error);
                addMessage(`❌ Voice processing failed: ${error.message}`, false);
            } finally {
                setLoading(false);
            }
        }
        
        // Integration Hub Interface
        async function loadIntegrationsInterface() {
            try {
                setLoading(true);
                
                // Fetch available and user integrations
                const [availableResponse, userResponse] = await Promise.all([
                    fetch('/integrations/available'),
                    fetch('/integrations/user')
                ]);
                
                if (!availableResponse.ok || !userResponse.ok) {
                    throw new Error('Failed to load integrations');
                }
                
                const availableData = await availableResponse.json();
                const userData = await userResponse.json();
                
                // Create integrations interface
                const integrationsHTML = createIntegrationsInterface(availableData.integrations, userData.integrations);
                
                // Clear chat and show integrations interface
                chatMessages.innerHTML = integrationsHTML;
                
            } catch (error) {
                console.error('Integrations loading failed:', error);
                addMessage(`❌ Failed to load integrations: ${error.message}`, false);
            } finally {
                setLoading(false);
            }
        }
        
        function createIntegrationsInterface(available, userIntegrations) {
            const userIntegrationsMap = {};
            userIntegrations.forEach(integration => {
                userIntegrationsMap[integration.service_id] = integration;
            });
            
            const integrationsHTML = `
                <div class="integrations-interface">
                    <div class="integrations-header">
                        <h2>🔗 Integration Hub</h2>
                        <p>Connect your favorite services to enhance your AI assistant</p>
                    </div>
                    
                    <div class="integrations-grid">
                        ${available.map(service => {
                            const userIntegration = userIntegrationsMap[service.id];
                            const isConnected = userIntegration && userIntegration.status === 'active';
                            
                            return `
                                <div class="integration-card ${isConnected ? 'connected' : ''}" data-service-id="${service.id}">
                                    <div class="integration-icon">
                                        ${getServiceIcon(service.id)}
                                    </div>
                                    <div class="integration-info">
                                        <h3>${service.name}</h3>
                                        <p>${service.description}</p>
                                        <div class="integration-status">
                                            ${isConnected ? 
                                                `<span class="status-connected">✅ Connected</span>` : 
                                                `<span class="status-disconnected">❌ Not connected</span>`
                                            }
                                        </div>
                                    </div>
                                    <div class="integration-actions">
                                        ${isConnected ? 
                                            `
                                            <button class="btn-disconnect" onclick="disconnectIntegration('${service.id}')">
                                                Disconnect
                                            </button>
                                            <button class="btn-test" onclick="testIntegration('${service.id}')">
                                                Test
                                            </button>
                                            ` : 
                                            `
                                            <button class="btn-connect" onclick="connectIntegration('${service.id}', '${service.type}')">
                                                Connect
                                            </button>
                                            `
                                        }
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="integration-suggestions">
                        <h3>💡 Suggestions</h3>
                        <div id="integration-suggestions">
                            <p>Loading AI-powered suggestions...</p>
                        </div>
                    </div>
                </div>
                
                <style>
                .integrations-interface {
                    padding: 20px;
                    max-width: 100%;
                }
                
                .integrations-header {
                    text-align: center;
                    margin-bottom: 30px;
                }
                
                .integrations-header h2 {
                    color: #333;
                    margin-bottom: 10px;
                }
                
                .integrations-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }
                
                .integration-card {
                    border: 2px solid #e9ecef;
                    border-radius: 12px;
                    padding: 20px;
                    display: flex;
                    align-items: center;
                    gap: 15px;
                    transition: all 0.3s;
                    background: white;
                }
                
                .integration-card:hover {
                    border-color: #667eea;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
                }
                
                .integration-card.connected {
                    border-color: #28a745;
                    background: #f8fff9;
                }
                
                .integration-icon {
                    font-size: 36px;
                    min-width: 60px;
                    text-align: center;
                }
                
                .integration-info {
                    flex: 1;
                }
                
                .integration-info h3 {
                    margin: 0 0 8px 0;
                    color: #333;
                }
                
                .integration-info p {
                    margin: 0 0 10px 0;
                    color: #666;
                    font-size: 14px;
                }
                
                .integration-status {
                    font-size: 12px;
                    font-weight: bold;
                }
                
                .status-connected {
                    color: #28a745;
                }
                
                .status-disconnected {
                    color: #dc3545;
                }
                
                .integration-actions {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    min-width: 100px;
                }
                
                .btn-connect, .btn-disconnect, .btn-test {
                    padding: 8px 16px;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: bold;
                    transition: all 0.3s;
                }
                
                .btn-connect {
                    background: #667eea;
                    color: white;
                }
                
                .btn-connect:hover {
                    background: #5a6fd8;
                }
                
                .btn-disconnect {
                    background: #dc3545;
                    color: white;
                }
                
                .btn-disconnect:hover {
                    background: #c82333;
                }
                
                .btn-test {
                    background: #ffc107;
                    color: #333;
                }
                
                .btn-test:hover {
                    background: #e0a800;
                }
                
                .integration-suggestions {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #e9ecef;
                }
                
                .integration-suggestions h3 {
                    margin: 0 0 15px 0;
                    color: #333;
                }
                </style>
            `;
            
            // Load suggestions after rendering
            setTimeout(loadIntegrationSuggestions, 1000);
            
            return integrationsHTML;
        }
        
        function getServiceIcon(serviceId) {
            const icons = {
                'github': '🐙',
                'slack': '💬',
                'gdrive': '📁',
                'notion': '📝',
                'trello': '📋',
                'calendar': '📅'
            };
            return icons[serviceId] || '🔧';
        }
        
        async function connectIntegration(serviceId, authType) {
            try {
                if (authType === 'oauth2') {
                    // For OAuth2, we would typically redirect to auth URL
                    addMessage(`🔗 OAuth2 integration for ${serviceId} would redirect to authentication page in a full implementation.`, false);
                } else if (authType === 'api_key') {
                    // For API key integrations, show input prompt
                    const apiKey = prompt(`Enter your ${serviceId} API key:`);
                    if (!apiKey) return;
                    
                    // For Trello, also ask for token
                    let additionalConfig = {};
                    if (serviceId === 'trello') {
                        const token = prompt('Enter your Trello token:');
                        if (!token) return;
                        additionalConfig.token = token;
                    }
                    
                    const response = await fetch('/integrations/api-key', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            service_id: serviceId,
                            api_key: apiKey,
                            additional_config: additionalConfig
                        })
                    });
                    
                    if (response.ok) {
                        addMessage(`✅ Successfully connected ${serviceId}!`, false);
                        await loadIntegrationsInterface(); // Refresh interface
                    } else {
                        throw new Error('Failed to connect integration');
                    }
                }
            } catch (error) {
                addMessage(`❌ Failed to connect ${serviceId}: ${error.message}`, false);
            }
        }
        
        async function disconnectIntegration(serviceId) {
            try {
                const response = await fetch(`/integrations/${serviceId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    addMessage(`✅ Successfully disconnected ${serviceId}!`, false);
                    await loadIntegrationsInterface(); // Refresh interface
                } else {
                    throw new Error('Failed to disconnect integration');
                }
            } catch (error) {
                addMessage(`❌ Failed to disconnect ${serviceId}: ${error.message}`, false);
            }
        }
        
        async function testIntegration(serviceId) {
            try {
                // Define test actions for each service
                const testActions = {
                    'github': { action_type: 'list_repos', parameters: {} },
                    'slack': { action_type: 'list_channels', parameters: {} },
                    'gdrive': { action_type: 'list_files', parameters: {} },
                    'notion': { action_type: 'list_databases', parameters: {} },
                    'trello': { action_type: 'list_boards', parameters: {} },
                    'calendar': { action_type: 'list_events', parameters: { calendar_id: 'primary' } }
                };
                
                const testAction = testActions[serviceId];
                if (!testAction) {
                    throw new Error(`No test action defined for ${serviceId}`);
                }
                
                const response = await fetch('/integrations/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service_id: serviceId,
                        action_type: testAction.action_type,
                        parameters: testAction.parameters
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addMessage(`✅ ${serviceId} test successful! Result: ${JSON.stringify(result.action.result, null, 2)}`, false);
                } else {
                    throw new Error('Test action failed');
                }
            } catch (error) {
                addMessage(`❌ ${serviceId} test failed: ${error.message}`, false);
            }
        }
        
        async function loadIntegrationSuggestions() {
            try {
                const response = await fetch('/integrations/suggestions', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const suggestionsElement = document.getElementById('integration-suggestions');
                    
                    if (data.suggestions.length > 0) {
                        suggestionsElement.innerHTML = data.suggestions.map(suggestion => `
                            <div class="suggestion-item">
                                <strong>${suggestion.service_id}:</strong> ${suggestion.reason}
                                <br><small>Actions: ${suggestion.actions.join(', ')}</small>
                            </div>
                        `).join('');
                    } else {
                        suggestionsElement.innerHTML = '<p>No specific suggestions at this time. Connect services based on your workflow needs!</p>';
                    }
                }
            } catch (error) {
                console.error('Failed to load integration suggestions:', error);
            }
        }
        
        // Security Dashboard Interface
        async function loadSecurityDashboard() {
            try {
                setLoading(true);
                
                // Fetch security dashboard data
                const [dashboardResponse, scanResponse] = await Promise.all([
                    fetch('/security/dashboard'),
                    fetch('/security/scan', { method: 'POST' })
                ]);
                
                if (!dashboardResponse.ok) {
                    throw new Error('Failed to load security dashboard');
                }
                
                const dashboardData = await dashboardResponse.json();
                const scanData = scanResponse.ok ? await scanResponse.json() : null;
                
                // Create security dashboard
                const securityHTML = createSecurityDashboard(dashboardData.dashboard, scanData?.scan);
                
                // Clear chat and show security dashboard
                chatMessages.innerHTML = securityHTML;
                
            } catch (error) {
                console.error('Security dashboard loading failed:', error);
                addMessage(`❌ Failed to load security dashboard: ${error.message}`, false);
            } finally {
                setLoading(false);
            }
        }
        
        function createSecurityDashboard(dashboard, scanResults) {
            const securityHTML = `
                <div class="security-dashboard">
                    <div class="security-header">
                        <h2>🔒 Security & Privacy Dashboard</h2>
                        <p>Comprehensive data protection and security monitoring</p>
                    </div>
                    
                    <div class="security-overview">
                        <div class="security-metric">
                            <div class="metric-value">${dashboard.summary.total_events}</div>
                            <div class="metric-label">Total Events</div>
                        </div>
                        <div class="security-metric ${dashboard.summary.high_risk_events > 0 ? 'warning' : ''}">
                            <div class="metric-value">${dashboard.summary.high_risk_events}</div>
                            <div class="metric-label">High Risk Events</div>
                        </div>
                        <div class="security-metric ${dashboard.summary.anomaly_count > 0 ? 'warning' : ''}">
                            <div class="metric-value">${dashboard.summary.anomaly_count}</div>
                            <div class="metric-label">Anomalies Detected</div>
                        </div>
                        <div class="security-metric">
                            <div class="metric-value">${dashboard.summary.active_policies}</div>
                            <div class="metric-label">Security Policies</div>
                        </div>
                    </div>
                    
                    ${scanResults ? `
                    <div class="security-scan-results">
                        <h3>🔍 Latest Security Scan</h3>
                        <div class="scan-score ${getScoreClass(scanResults.score)}">
                            Security Score: ${scanResults.score}/100
                        </div>
                        ${scanResults.issues.length > 0 ? `
                            <div class="scan-issues">
                                <h4>Issues Found:</h4>
                                ${scanResults.issues.map(issue => `
                                    <div class="scan-issue ${issue.severity}">
                                        <span class="issue-severity">${issue.severity.toUpperCase()}</span>
                                        <span class="issue-description">${issue.description}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="no-issues">✅ No security issues found</p>'}
                        
                        ${scanResults.recommendations.length > 0 ? `
                            <div class="scan-recommendations">
                                <h4>Recommendations:</h4>
                                <ul>
                                    ${scanResults.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <div class="security-tools">
                        <h3>🛠️ Security Tools</h3>
                        <div class="security-actions">
                            <button class="security-btn" onclick="showDataClassifier()">
                                🏷️ Classify Data
                            </button>
                            <button class="security-btn" onclick="showEncryptionTool()">
                                🔐 Encrypt/Decrypt
                            </button>
                            <button class="security-btn" onclick="showAnonymizationTool()">
                                🕶️ Anonymize Data
                            </button>
                            <button class="security-btn" onclick="viewAuditLogs()">
                                📋 Audit Logs
                            </button>
                            <button class="security-btn" onclick="runSecurityScan()">
                                🔍 Run Security Scan
                            </button>
                        </div>
                    </div>
                    
                    <div class="data-classification-stats">
                        <h3>📊 Data Classification</h3>
                        <div class="classification-grid">
                            ${Object.entries(dashboard.summary.classification_stats).map(([category, count]) => `
                                <div class="classification-item">
                                    <div class="classification-category">${category}</div>
                                    <div class="classification-count">${count}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="recent-security-events">
                        <h3>⚠️ Recent Security Events</h3>
                        <div class="events-list">
                            ${dashboard.recent_events.map(event => `
                                <div class="security-event ${event.risk_score >= 70 ? 'high-risk' : ''}">
                                    <div class="event-header">
                                        <span class="event-type">${event.type}</span>
                                        <span class="event-risk">Risk: ${event.risk_score}/100</span>
                                        <span class="event-time">${new Date(event.timestamp).toLocaleString()}</span>
                                    </div>
                                    <div class="event-action">${event.action}</div>
                                    ${event.anomaly ? '<span class="anomaly-badge">⚠️ Anomaly</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <style>
                .security-dashboard {
                    padding: 20px;
                    max-width: 100%;
                }
                
                .security-header {
                    text-align: center;
                    margin-bottom: 30px;
                }
                
                .security-header h2 {
                    color: #333;
                    margin-bottom: 10px;
                }
                
                .security-overview {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }
                
                .security-metric {
                    background: white;
                    padding: 20px;
                    border-radius: 12px;
                    border: 2px solid #e9ecef;
                    text-align: center;
                }
                
                .security-metric.warning {
                    border-color: #ffc107;
                    background: #fff9e6;
                }
                
                .metric-value {
                    font-size: 32px;
                    font-weight: bold;
                    color: #333;
                    margin-bottom: 8px;
                }
                
                .metric-label {
                    font-size: 14px;
                    color: #666;
                }
                
                .security-scan-results {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 12px;
                    margin-bottom: 30px;
                    border: 1px solid #e9ecef;
                }
                
                .scan-score {
                    font-size: 24px;
                    font-weight: bold;
                    margin: 15px 0;
                    padding: 10px;
                    border-radius: 8px;
                    text-align: center;
                }
                
                .scan-score.excellent { background: #d4edda; color: #155724; }
                .scan-score.good { background: #d1ecf1; color: #0c5460; }
                .scan-score.fair { background: #fff3cd; color: #856404; }
                .scan-score.poor { background: #f8d7da; color: #721c24; }
                
                .scan-issue {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 10px;
                    margin: 8px 0;
                    border-radius: 6px;
                }
                
                .scan-issue.high { background: #f8d7da; }
                .scan-issue.medium { background: #fff3cd; }
                .scan-issue.low { background: #d1ecf1; }
                
                .issue-severity {
                    font-weight: bold;
                    font-size: 12px;
                    padding: 2px 8px;
                    border-radius: 4px;
                    color: white;
                }
                
                .scan-issue.high .issue-severity { background: #dc3545; }
                .scan-issue.medium .issue-severity { background: #ffc107; color: #333; }
                .scan-issue.low .issue-severity { background: #17a2b8; }
                
                .security-tools {
                    margin-bottom: 30px;
                }
                
                .security-actions {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin-top: 15px;
                }
                
                .security-btn {
                    padding: 12px 20px;
                    border: 2px solid #667eea;
                    border-radius: 8px;
                    background: white;
                    color: #667eea;
                    cursor: pointer;
                    transition: all 0.3s;
                    font-weight: bold;
                }
                
                .security-btn:hover {
                    background: #667eea;
                    color: white;
                }
                
                .data-classification-stats {
                    margin-bottom: 30px;
                }
                
                .classification-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 15px;
                    margin-top: 15px;
                }
                
                .classification-item {
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #e9ecef;
                    text-align: center;
                }
                
                .classification-category {
                    font-weight: bold;
                    color: #333;
                    margin-bottom: 8px;
                    text-transform: capitalize;
                }
                
                .classification-count {
                    font-size: 24px;
                    color: #667eea;
                    font-weight: bold;
                }
                
                .security-event {
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    border: 1px solid #e9ecef;
                    margin-bottom: 10px;
                }
                
                .security-event.high-risk {
                    border-color: #dc3545;
                    background: #fff5f5;
                }
                
                .event-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 8px;
                    flex-wrap: wrap;
                    gap: 10px;
                }
                
                .event-type {
                    font-weight: bold;
                    color: #333;
                }
                
                .event-risk {
                    font-size: 12px;
                    color: #666;
                }
                
                .event-time {
                    font-size: 12px;
                    color: #999;
                }
                
                .event-action {
                    color: #666;
                    font-size: 14px;
                }
                
                .anomaly-badge {
                    background: #ffc107;
                    color: #333;
                    padding: 2px 8px;
                    border-radius: 4px;
                    font-size: 11px;
                    font-weight: bold;
                }
                
                .no-issues {
                    color: #28a745;
                    font-weight: bold;
                    text-align: center;
                    padding: 20px;
                }
                </style>
            `;
            
            return securityHTML;
        }
        
        function getScoreClass(score) {
            if (score >= 90) return 'excellent';
            if (score >= 75) return 'good';
            if (score >= 60) return 'fair';
            return 'poor';
        }
        
        // Security tool functions
        async function showDataClassifier() {
            const text = prompt('Enter text to classify for security analysis:');
            if (!text) return;
            
            try {
                const response = await fetch('/security/classify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data_type: 'user_input',
                        data_id: Date.now().toString(),
                        content: text
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const classification = result.classification;
                    addMessage(`🏷️ Data Classification Results:
Category: ${classification.category}
Sensitivity Score: ${classification.sensitivity_score}/10
Contains PII: ${classification.contains_pii ? 'Yes' : 'No'}
Contains Secrets: ${classification.contains_secrets ? 'Yes' : 'No'}
Detected Patterns: ${classification.detected_patterns.join(', ') || 'None'}
Recommendation: ${classification.recommendation}`, false);
                } else {
                    throw new Error('Classification failed');
                }
            } catch (error) {
                addMessage(`❌ Classification failed: ${error.message}`, false);
            }
        }
        
        async function showEncryptionTool() {
            const action = prompt('Enter "encrypt" or "decrypt":');
            if (!action || !['encrypt', 'decrypt'].includes(action.toLowerCase())) return;
            
            try {
                if (action.toLowerCase() === 'encrypt') {
                    const text = prompt('Enter text to encrypt:');
                    if (!text) return;
                    
                    const response = await fetch('/security/encrypt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        addMessage(`🔐 Encryption successful! Encrypted data: ${result.encrypted_data}`, false);
                    } else {
                        throw new Error('Encryption failed');
                    }
                } else {
                    const encryptedData = prompt('Enter encrypted data to decrypt:');
                    if (!encryptedData) return;
                    
                    const response = await fetch('/security/decrypt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ encrypted_data: encryptedData })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        addMessage(`🔓 Decryption successful! Decrypted data: ${result.decrypted_data}`, false);
                    } else {
                        throw new Error('Decryption failed');
                    }
                }
            } catch (error) {
                addMessage(`❌ ${action} failed: ${error.message}`, false);
            }
        }
        
        async function showAnonymizationTool() {
            const text = prompt('Enter text to anonymize:');
            if (!text) return;
            
            const level = prompt('Enter anonymization level (standard/aggressive):') || 'standard';
            
            try {
                const response = await fetch('/security/anonymize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, level: level })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addMessage(`🕶️ Anonymization successful!
Level: ${result.level}
Anonymized text: ${result.anonymized_data}`, false);
                } else {
                    throw new Error('Anonymization failed');
                }
            } catch (error) {
                addMessage(`❌ Anonymization failed: ${error.message}`, false);
            }
        }
        
        async function viewAuditLogs() {
            try {
                const response = await fetch('/security/audit-logs?limit=20');
                
                if (response.ok) {
                    const result = await response.json();
                    const logs = result.logs;
                    
                    const logsDisplay = logs.map(log => 
                        `[${new Date(log.timestamp).toLocaleString()}] ${log.event_type}: ${log.action} (Risk: ${log.risk_score}/100)${log.anomaly_detected ? ' ⚠️ ANOMALY' : ''}`
                    ).join('\n');
                    
                    addMessage(`📋 Recent Audit Logs (${logs.length} entries):
${logsDisplay || 'No logs found'}`, false);
                } else {
                    throw new Error('Failed to fetch audit logs');
                }
            } catch (error) {
                addMessage(`❌ Failed to view audit logs: ${error.message}`, false);
            }
        }
        
        async function runSecurityScan() {
            try {
                addMessage('🔍 Running comprehensive security scan...', false);
                
                const response = await fetch('/security/scan', { method: 'POST' });
                
                if (response.ok) {
                    const result = await response.json();
                    const scan = result.scan;
                    
                    const issuesText = scan.issues.length > 0 ? 
                        scan.issues.map(issue => `- ${issue.severity.toUpperCase()}: ${issue.description}`).join('\n') :
                        '✅ No issues found';
                    
                    const recommendationsText = scan.recommendations.length > 0 ?
                        scan.recommendations.map(rec => `- ${rec}`).join('\n') :
                        'No specific recommendations';
                    
                    addMessage(`🔍 Security Scan Complete!
Security Score: ${scan.score}/100

Issues Found:
${issuesText}

Recommendations:
${recommendationsText}`, false);
                    
                    // Refresh dashboard after scan
                    await loadSecurityDashboard();
                } else {
                    throw new Error('Security scan failed');
                }
            } catch (error) {
                addMessage(`❌ Security scan failed: ${error.message}`, false);
            }
        }
        
        // Data Visualization Interface
        async function loadDataVisualizationInterface() {
            try {
                setLoading(true);
                
                // Fetch saved visualizations
                const visualizationsResponse = await fetch('/data/visualizations');
                
                if (!visualizationsResponse.ok) {
                    throw new Error('Failed to load visualizations');
                }
                
                const visualizationsData = await visualizationsResponse.json();
                
                // Create data visualization interface
                const dataVizHTML = createDataVisualizationInterface(visualizationsData.visualizations);
                
                // Clear chat and show data visualization interface
                chatMessages.innerHTML = dataVizHTML;
                
            } catch (error) {
                console.error('Data visualization loading failed:', error);
                addMessage(`❌ Failed to load data visualization interface: ${error.message}`, false);
            } finally {
                setLoading(false);
            }
        }
        
        function createDataVisualizationInterface(savedVisualizations) {
            const dataVizHTML = `
                <div class="data-viz-interface">
                    <div class="data-viz-header">
                        <h2>📊 Visual Data Explorer</h2>
                        <p>Create interactive charts, graphs, and data visualizations</p>
                    </div>
                    
                    <div class="data-viz-tabs">
                        <button class="tab-btn active" onclick="showTab('create')">Create New</button>
                        <button class="tab-btn" onclick="showTab('gallery')">Gallery</button>
                        <button class="tab-btn" onclick="showTab('samples')">Sample Data</button>
                    </div>
                    
                    <div id="tab-create" class="tab-content active">
                        <div class="viz-creator">
                            <h3>🎨 Create Visualization</h3>
                            
                            <div class="creator-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Data Source:</label>
                                        <select id="data-source" onchange="updateDataSourceOptions()">
                                            <option value="sales">Sample Sales Data</option>
                                            <option value="users">Sample User Data</option>
                                            <option value="stocks">Sample Stock Data</option>
                                            <option value="conversations">Your Conversations</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Chart Type:</label>
                                        <select id="chart-type">
                                            <option value="line">Line Chart</option>
                                            <option value="bar">Bar Chart</option>
                                            <option value="scatter">Scatter Plot</option>
                                            <option value="pie">Pie Chart</option>
                                            <option value="histogram">Histogram</option>
                                            <option value="heatmap">Heatmap</option>
                                            <option value="box">Box Plot</option>
                                            <option value="area">Area Chart</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Visualization Name:</label>
                                        <input type="text" id="viz-name" placeholder="My Chart">
                                    </div>
                                    <div class="form-group">
                                        <label>Description:</label>
                                        <input type="text" id="viz-description" placeholder="Chart description">
                                    </div>
                                </div>
                                
                                <div id="column-selectors">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>X-Axis Column:</label>
                                            <select id="x-column">
                                                <option value="">Select column...</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Y-Axis Column:</label>
                                            <select id="y-column">
                                                <option value="">Select column...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Color By:</label>
                                            <select id="color-column">
                                                <option value="">None</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Aggregation:</label>
                                            <select id="aggregation">
                                                <option value="">None</option>
                                                <option value="count">Count</option>
                                                <option value="sum">Sum</option>
                                                <option value="mean">Mean</option>
                                                <option value="median">Median</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions">
                                    <button class="viz-btn primary" onclick="previewVisualization()">
                                        👁️ Preview
                                    </button>
                                    <button class="viz-btn primary" onclick="createVisualization()">
                                        ✨ Create Visualization
                                    </button>
                                    <button class="viz-btn secondary" onclick="analyzeCurrentData()">
                                        🔍 Analyze Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-gallery" class="tab-content">
                        <div class="viz-gallery">
                            <h3>🖼️ Saved Visualizations</h3>
                            <div class="gallery-grid">
                                ${savedVisualizations.length > 0 ? savedVisualizations.map(viz => `
                                    <div class="viz-card" data-viz-id="${viz.id}">
                                        <div class="viz-preview">
                                            <div class="viz-type-icon">${getChartIcon(viz.chart_type)}</div>
                                        </div>
                                        <div class="viz-info">
                                            <h4>${viz.name}</h4>
                                            <p>${viz.description || 'No description'}</p>
                                            <div class="viz-meta">
                                                <span class="viz-type">${viz.chart_type}</span>
                                                <span class="viz-source">${viz.data_source}</span>
                                            </div>
                                            <div class="viz-stats">
                                                ${viz.data_rows} rows • ${viz.data_columns} columns
                                            </div>
                                        </div>
                                        <div class="viz-actions">
                                            <button class="viz-btn small" onclick="viewVisualization('${viz.id}')">
                                                View
                                            </button>
                                            <button class="viz-btn small secondary" onclick="duplicateVisualization('${viz.id}')">
                                                Duplicate
                                            </button>
                                        </div>
                                    </div>
                                `).join('') : '<p class="no-visualizations">No saved visualizations yet. Create your first one!</p>'}
                            </div>
                            
                            ${savedVisualizations.length > 1 ? `
                                <div class="dashboard-creator">
                                    <h4>📈 Create Dashboard</h4>
                                    <p>Combine multiple visualizations into a dashboard</p>
                                    <button class="viz-btn primary" onclick="createDashboard()">
                                        Create Dashboard
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div id="tab-samples" class="tab-content">
                        <div class="sample-data">
                            <h3>📋 Sample Datasets</h3>
                            <div class="sample-grid">
                                <div class="sample-card" onclick="loadSampleData('sales')">
                                    <div class="sample-icon">💰</div>
                                    <h4>Sales Data</h4>
                                    <p>Daily sales by region and product with profit margins</p>
                                    <div class="sample-meta">Time series • Regional • Commercial</div>
                                </div>
                                <div class="sample-card" onclick="loadSampleData('users')">
                                    <div class="sample-icon">👥</div>
                                    <h4>User Analytics</h4>
                                    <p>User demographics, behavior, and satisfaction scores</p>
                                    <div class="sample-meta">Demographics • Behavioral • Survey</div>
                                </div>
                                <div class="sample-card" onclick="loadSampleData('stocks')">
                                    <div class="sample-icon">📈</div>
                                    <h4>Stock Market</h4>
                                    <p>Stock prices, volumes, and market data over time</p>
                                    <div class="sample-meta">Financial • Time series • Market</div>
                                </div>
                                <div class="sample-card" onclick="loadSampleData('conversations')">
                                    <div class="sample-icon">💬</div>
                                    <h4>Your Conversations</h4>
                                    <p>Analytics from your agent conversations and usage</p>
                                    <div class="sample-meta">Personal • Usage • Analytics</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                .data-viz-interface {
                    padding: 20px;
                    max-width: 100%;
                }
                
                .data-viz-header {
                    text-align: center;
                    margin-bottom: 30px;
                }
                
                .data-viz-header h2 {
                    color: #333;
                    margin-bottom: 10px;
                }
                
                .data-viz-tabs {
                    display: flex;
                    border-bottom: 2px solid #e9ecef;
                    margin-bottom: 30px;
                }
                
                .tab-btn {
                    padding: 12px 24px;
                    border: none;
                    background: transparent;
                    cursor: pointer;
                    border-bottom: 2px solid transparent;
                    transition: all 0.3s;
                    font-weight: bold;
                }
                
                .tab-btn:hover {
                    background: #f8f9fa;
                }
                
                .tab-btn.active {
                    border-bottom-color: #667eea;
                    color: #667eea;
                }
                
                .tab-content {
                    display: none;
                }
                
                .tab-content.active {
                    display: block;
                }
                
                .creator-form {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 12px;
                    border: 1px solid #e9ecef;
                }
                
                .form-row {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    margin-bottom: 20px;
                }
                
                .form-group {
                    display: flex;
                    flex-direction: column;
                }
                
                .form-group label {
                    font-weight: bold;
                    margin-bottom: 8px;
                    color: #333;
                }
                
                .form-group select, .form-group input {
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    font-size: 14px;
                }
                
                .form-actions {
                    display: flex;
                    gap: 15px;
                    margin-top: 30px;
                    flex-wrap: wrap;
                }
                
                .viz-btn {
                    padding: 12px 24px;
                    border: 2px solid #667eea;
                    border-radius: 8px;
                    background: white;
                    color: #667eea;
                    cursor: pointer;
                    transition: all 0.3s;
                    font-weight: bold;
                    font-size: 14px;
                }
                
                .viz-btn:hover {
                    background: #667eea;
                    color: white;
                }
                
                .viz-btn.primary {
                    background: #667eea;
                    color: white;
                }
                
                .viz-btn.primary:hover {
                    background: #5a6fd8;
                }
                
                .viz-btn.secondary {
                    border-color: #6c757d;
                    color: #6c757d;
                }
                
                .viz-btn.secondary:hover {
                    background: #6c757d;
                    color: white;
                }
                
                .viz-btn.small {
                    padding: 6px 12px;
                    font-size: 12px;
                }
                
                .gallery-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }
                
                .viz-card {
                    background: white;
                    border: 1px solid #e9ecef;
                    border-radius: 12px;
                    padding: 20px;
                    transition: all 0.3s;
                }
                
                .viz-card:hover {
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    border-color: #667eea;
                }
                
                .viz-preview {
                    height: 100px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-bottom: 15px;
                }
                
                .viz-type-icon {
                    font-size: 36px;
                }
                
                .viz-info h4 {
                    margin: 0 0 8px 0;
                    color: #333;
                }
                
                .viz-info p {
                    margin: 0 0 10px 0;
                    color: #666;
                    font-size: 14px;
                }
                
                .viz-meta {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 8px;
                }
                
                .viz-type, .viz-source {
                    font-size: 12px;
                    padding: 2px 8px;
                    border-radius: 4px;
                    background: #e9ecef;
                    color: #495057;
                }
                
                .viz-stats {
                    font-size: 12px;
                    color: #999;
                    margin-bottom: 15px;
                }
                
                .viz-actions {
                    display: flex;
                    gap: 8px;
                }
                
                .sample-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 20px;
                }
                
                .sample-card {
                    background: white;
                    border: 1px solid #e9ecef;
                    border-radius: 12px;
                    padding: 20px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s;
                }
                
                .sample-card:hover {
                    border-color: #667eea;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
                }
                
                .sample-icon {
                    font-size: 48px;
                    margin-bottom: 15px;
                }
                
                .sample-card h4 {
                    margin: 0 0 10px 0;
                    color: #333;
                }
                
                .sample-card p {
                    margin: 0 0 15px 0;
                    color: #666;
                    font-size: 14px;
                }
                
                .sample-meta {
                    font-size: 12px;
                    color: #999;
                    font-style: italic;
                }
                
                .dashboard-creator {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 12px;
                    text-align: center;
                    border: 1px solid #e9ecef;
                }
                
                .no-visualizations {
                    text-align: center;
                    color: #999;
                    font-style: italic;
                    padding: 40px;
                }
                </style>
            `;
            
            // Initialize with sales data columns
            setTimeout(() => {
                updateDataSourceOptions();
            }, 100);
            
            return dataVizHTML;
        }
        
        function getChartIcon(chartType) {
            const icons = {
                'line': '📈',
                'bar': '📊',
                'scatter': '🔸',
                'pie': '🥧',
                'histogram': '📋',
                'heatmap': '🔥',
                'box': '📦',
                'area': '🌄'
            };
            return icons[chartType] || '📊';
        }
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        async function updateDataSourceOptions() {
            const dataSource = document.getElementById('data-source').value;
            
            try {
                const response = await fetch(`/data/sample/${dataSource}?rows=10`);
                if (response.ok) {
                    const data = await response.json();
                    const columns = data.columns;
                    
                    // Update column selectors
                    const xSelect = document.getElementById('x-column');
                    const ySelect = document.getElementById('y-column');
                    const colorSelect = document.getElementById('color-column');
                    
                    // Clear and repopulate
                    [xSelect, ySelect, colorSelect].forEach(select => {
                        select.innerHTML = '<option value="">Select column...</option>';
                        columns.forEach(col => {
                            select.innerHTML += `<option value="${col}">${col}</option>`;
                        });
                    });
                    
                    // Add "None" option for color
                    colorSelect.innerHTML = '<option value="">None</option>' + colorSelect.innerHTML.substring(colorSelect.innerHTML.indexOf('<option value="">Select column...'));
                }
            } catch (error) {
                console.error('Failed to update data source options:', error);
            }
        }
        
        async function analyzeCurrentData() {
            const dataSource = document.getElementById('data-source').value;
            
            try {
                addMessage('🔍 Analyzing data...', false);
                
                const response = await fetch('/data/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data_type: dataSource,
                        rows: 100
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const analysis = result.analysis;
                    
                    let analysisText = `📊 Data Analysis Results for ${dataSource}:
                    
Dataset Info:
• ${analysis.dataset_info.rows} rows, ${analysis.dataset_info.columns} columns
• Size: ${analysis.dataset_info.size_mb.toFixed(2)} MB
• Data Quality Score: ${analysis.data_quality.overall_completeness.toFixed(1)}%

Suggested Visualizations:`;
                    
                    analysis.suggested_visualizations.forEach((viz, i) => {
                        analysisText += `\n${i + 1}. ${viz.title} (${viz.type})`;
                    });
                    
                    if (analysis.data_quality.recommendations.length > 0) {
                        analysisText += '\n\nRecommendations:\n' + analysis.data_quality.recommendations.map(r => `• ${r}`).join('\n');
                    }
                    
                    addMessage(analysisText, false);
                } else {
                    throw new Error('Analysis failed');
                }
            } catch (error) {
                addMessage(`❌ Data analysis failed: ${error.message}`, false);
            }
        }
        
        async function createVisualization() {
            const config = {
                name: document.getElementById('viz-name').value || 'My Visualization',
                description: document.getElementById('viz-description').value,
                chart_type: document.getElementById('chart-type').value,
                data_source: document.getElementById('data-source').value,
                config: {
                    title: document.getElementById('viz-name').value || 'My Visualization',
                    x_column: document.getElementById('x-column').value || null,
                    y_column: document.getElementById('y-column').value || null,
                    color_column: document.getElementById('color-column').value || null,
                    aggregation: document.getElementById('aggregation').value || null,
                    interactive: true
                }
            };
            
            try {
                addMessage('✨ Creating visualization...', false);
                
                const response = await fetch('/data/visualize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const viz = result.visualization;
                    
                    addMessage(`✅ Visualization "${viz.name}" created successfully!
Chart Type: ${viz.chart_type}
Data Source: ${viz.data_source}
Dimensions: ${viz.data_rows} rows × ${viz.data_columns} columns

View it in the Gallery tab or create more visualizations!`, false);
                    
                    // Refresh the interface to show new visualization
                    await loadDataVisualizationInterface();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Visualization creation failed');
                }
            } catch (error) {
                addMessage(`❌ Visualization creation failed: ${error.message}`, false);
            }
        }
        
        async function loadSampleData(dataType) {
            try {
                document.getElementById('data-source').value = dataType;
                await updateDataSourceOptions();
                showTab('create');
                addMessage(`📋 Loaded ${dataType} sample data. Configure your visualization in the Create New tab!`, false);
            } catch (error) {
                addMessage(`❌ Failed to load sample data: ${error.message}`, false);
            }
        }
        
        async function viewVisualization(vizId) {
            try {
                const response = await fetch(`/data/visualizations/${vizId}`);
                if (response.ok) {
                    const result = await response.json();
                    const viz = result.visualization;
                    
                    if (viz.plotly_json) {
                        // Display interactive visualization
                        const plotlyData = JSON.parse(viz.plotly_json);
                        
                        // Create a container for the visualization
                        const vizContainer = document.createElement('div');
                        vizContainer.style.cssText = 'width: 100%; height: 500px; margin: 20px 0; border: 1px solid #ddd; border-radius: 8px;';
                        chatMessages.appendChild(vizContainer);
                        
                        // Load Plotly if not already loaded
                        if (typeof Plotly === 'undefined') {
                            const script = document.createElement('script');
                            script.src = 'https://cdn.plot.ly/plotly-latest.min.js';
                            script.onload = () => {
                                Plotly.newPlot(vizContainer, plotlyData.data, plotlyData.layout);
                            };
                            document.head.appendChild(script);
                        } else {
                            Plotly.newPlot(vizContainer, plotlyData.data, plotlyData.layout);
                        }
                        
                        addMessage(`📊 Displaying visualization: ${viz.name}`, false);
                    } else {
                        addMessage(`📊 Visualization: ${viz.name}\nType: ${viz.chart_type}\nCreated: ${new Date(viz.created_at).toLocaleString()}`, false);
                    }
                } else {
                    throw new Error('Failed to load visualization');
                }
            } catch (error) {
                addMessage(`❌ Failed to view visualization: ${error.message}`, false);
            }
        }
    </script>
</body>
</html>